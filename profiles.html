<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Profiles | AI Knowledge Hub</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,600;1,400&family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600;9..40,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' rx='36' fill='%23c45c3e'/%3E%3Cpath d='M90 52l18 36 40 7-29 29 7 40-36-18-36 18 7-40-29-29 40-7z' fill='white'/%3E%3C/svg%3E">
  <style>
    .profile-admin-section { margin-top: 2.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border); }
    .profile-admin-section h2 { font-size: 1.1rem; margin-bottom: 0.5rem; }
    .profile-admin-section .intro { color: var(--text-muted); margin-bottom: 1rem; font-size: 0.9rem; }
    .profile-admin-section label { display: block; margin-top: 0.75rem; font-weight: 500; font-size: 0.9rem; }
    .profile-admin-section input, .profile-admin-section select, .profile-admin-section textarea { width: 100%; padding: 0.5rem 0.75rem; margin-top: 0.25rem; font-family: inherit; font-size: 0.95rem; background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text); }
    .profile-admin-section .admin-form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
    .profile-admin-section .admin-form-actions { display: flex; gap: 0.5rem; margin-top: 1rem; }
    .profile-admin-section .admin-form-actions button { padding: 0.5rem 1rem; font-size: 0.9rem; font-weight: 600; border-radius: var(--radius); cursor: pointer; border: none; }
    .profile-admin-section .admin-form-actions button[type="submit"] { background: var(--accent); color: var(--bg); }
    .profile-admin-section .admin-tools-list { margin-top: 1.5rem; }
    .profile-admin-section .admin-tool-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0.75rem; background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 0.4rem; gap: 0.5rem; flex-wrap: wrap; }
    .profile-admin-section .admin-tool-item a { color: var(--accent); text-decoration: none; }
    .profile-admin-section .admin-tool-item button { padding: 0.25rem 0.5rem; font-size: 0.75rem; background: transparent; color: var(--text-muted); border: none; cursor: pointer; }
    .profile-admin-section .admin-tool-item button:hover { color: #e74c3c; }
    .profile-admin-section .admin-tool-item button.admin-edit-btn:hover { color: var(--accent); }
    .profile-admin-section .admin-export { margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border); }
    .profile-admin-section .admin-export pre { background: var(--bg-surface); padding: 0.75rem; border-radius: var(--radius); font-size: 0.75rem; overflow-x: auto; max-height: 150px; overflow-y: auto; }

    .profile-settings-section { margin-top: 2.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border); }
    .profile-settings-section .intro { color: var(--text-muted); margin-bottom: 1.25rem; font-size: 0.9rem; }
    .settings-card { display: flex; align-items: center; justify-content: space-between; gap: 1rem; padding: 1rem 1.25rem; background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 0.75rem; flex-wrap: wrap; }
    .settings-card-header { display: flex; align-items: flex-start; gap: 0.75rem; flex: 1; min-width: 0; }
    .settings-card-icon { font-size: 1.25rem; flex-shrink: 0; margin-top: 0.1rem; }
    .settings-card-header strong { display: block; font-size: 0.95rem; margin-bottom: 0.15rem; }
    .settings-card-desc { color: var(--text-muted); font-size: 0.85rem; margin: 0; line-height: 1.4; }
    .settings-card-link { padding: 0.45rem 0.9rem; font-size: 0.85rem; font-weight: 600; color: var(--accent); background: var(--accent-muted); border: none; border-radius: var(--radius); cursor: pointer; white-space: nowrap; text-decoration: none; transition: background 0.15s, color 0.15s; flex-shrink: 0; }
    .settings-card-link:hover { background: var(--accent); color: var(--bg); }
    .settings-logout-btn { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
    .settings-logout-btn:hover { background: var(--bg-surface); color: var(--text); border-color: var(--text-muted); }
  </style>
</head>
<body>
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <div id="header-root"></div>
  <script src="header.js"></script>
  <script>Header.render({ activeNav: null, searchMode: "expandable" });</script>
  <script src="theme.js"></script>
  <script src="mobile-ux.js"></script>
  <script src="offline.js"></script>

  <main class="main profiles-main" id="main-content" style="max-width: 600px; margin: 0 auto; padding: 2rem 1.25rem;">
    <section class="section">
      <h1 class="section-title">Profiles</h1>
      <p class="section-intro" style="margin-bottom: 1.5rem;">Each profile has its own stack, ratings, and flags. Switch between Work, Personal, or any other context.</p>

      <div class="data-export-import">
        <h2 class="profile-form-title">Backup & restore</h2>
        <p class="section-intro" style="margin-bottom: 0.75rem;">Export your profiles, stack, ratings, and flags. Import on another device to restore.</p>
        <div class="data-actions">
          <button type="button" id="data-export-btn" class="profile-form-btn">Export data</button>
          <label class="data-import-label">
            <input type="file" id="data-import-input" accept=".json,application/json" class="sr-only">
            <span class="profile-form-btn">Import data</span>
          </label>
        </div>
        <p id="data-feedback" class="data-feedback" role="status" aria-live="polite" style="display:none"></p>
      </div>

      <span id="profile-announcer" class="sr-only" aria-live="polite" aria-atomic="true"></span>
      <div id="profiles-list" class="profiles-list" role="listbox" aria-label="Profiles"></div>

      <form id="profile-form" class="profile-form">
        <h2 class="profile-form-title">Create profile</h2>
        <div class="profile-form-row">
          <input type="text" id="profile-name" placeholder="Profile name" required maxlength="50" aria-label="Profile name">
          <button type="submit" class="profile-form-btn">Add</button>
        </div>
      </form>

      <div id="profile-admin-section" class="profile-admin-section" style="display:none">
        <h2 class="profile-form-title" id="profile-tool-form-heading">Add tool</h2>
        <p class="intro">Add custom tools that appear in your hub. They are stored in your browser.</p>
        <form id="profile-tool-form">
          <label for="profile-tool-title">Title *</label>
          <input type="text" id="profile-tool-title" required placeholder="e.g. ChatGPT">
          <label for="profile-tool-description">Description *</label>
          <textarea id="profile-tool-description" rows="2" required placeholder="Short summary"></textarea>
          <label for="profile-tool-url">URL</label>
          <input type="url" id="profile-tool-url" placeholder="https://...">
          <div class="admin-form-row">
            <div>
              <label for="profile-tool-category">Category *</label>
              <select id="profile-tool-category" required>
                <option value="tools">AI Tools</option>
                <option value="knowledge">Knowledge</option>
                <option value="podcasts">Podcasts</option>
                <option value="youtube">YouTube</option>
                <option value="training">Training</option>
                <option value="dailyWatch">Daily Watch</option>
                <option value="bleedingEdge">Bleeding Edge</option>
              </select>
            </div>
            <div>
              <label for="profile-tool-icon">Icon (emoji)</label>
              <input type="text" id="profile-tool-icon" placeholder="üí¨" maxlength="4">
            </div>
          </div>
          <div class="admin-form-row">
            <div>
              <label for="profile-tool-level">Level (1‚Äì10)</label>
              <input type="number" id="profile-tool-level" min="1" max="10" value="1">
            </div>
            <div>
              <label for="profile-tool-freq">Frequency</label>
              <input type="text" id="profile-tool-freq" placeholder="e.g. Continuous">
            </div>
          </div>
          <label for="profile-tool-tags">Tags (comma-separated)</label>
          <input type="text" id="profile-tool-tags" placeholder="LLM, Writing">
          <label>Color gradient (hex)</label>
          <div class="admin-form-row">
            <input type="text" id="profile-tool-color1" placeholder="#10a37f" maxlength="7">
            <input type="text" id="profile-tool-color2" placeholder="#1a7f5a" maxlength="7">
          </div>
          <div class="admin-form-actions">
            <button type="submit" class="profile-form-btn">Add tool</button>
            <button type="button" id="profile-reset-form">Reset</button>
            <button type="button" id="profile-cancel-edit" style="display:none">Cancel edit</button>
          </div>
        </form>
        <div class="admin-tools-list" id="profile-custom-tools-list"></div>
        <div class="admin-export">
          <h2 class="profile-form-title">Export for data.js</h2>
          <p class="intro">Copy to make custom tools permanent in your data.</p>
          <button type="button" id="profile-admin-copy" class="profile-form-btn">Copy to clipboard</button>
          <span id="profile-copy-feedback" aria-live="polite" style="margin-left:0.5rem;font-size:0.9rem;color:var(--accent)"></span>
          <pre id="profile-export-output" style="margin-top:0.5rem"></pre>
        </div>
      </div>

      <div id="profile-settings-section" class="profile-settings-section" style="display:none">
        <h2 class="profile-form-title">Settings</h2>
        <p class="intro">Admin tools and site management.</p>

        <div class="settings-card">
          <div class="settings-card-header">
            <span class="settings-card-icon">&#x2699;</span>
            <div>
              <strong>Tool management</strong>
              <p class="settings-card-desc">Add, edit, or remove tools across all categories. Export custom tools to data.js.</p>
            </div>
          </div>
          <a href="admin.html" class="settings-card-link">Open admin panel</a>
        </div>

        <div class="settings-card">
          <div class="settings-card-header">
            <span class="settings-card-icon">&#x1F464;</span>
            <div>
              <strong>Account</strong>
              <p class="settings-card-desc" id="settings-account-email"></p>
            </div>
          </div>
          <button type="button" class="settings-card-link settings-logout-btn" id="settings-logout">Log out</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Mobile bottom navigation -->
  <nav class="bottom-nav" aria-label="Mobile navigation">
    <div class="bottom-nav-inner">
      <a href="index.html" class="bottom-nav-item">
        <span class="bottom-nav-icon" aria-hidden="true">üè†</span>
        <span class="bottom-nav-label">Home</span>
      </a>
      <a href="tools.html" class="bottom-nav-item">
        <span class="bottom-nav-icon" aria-hidden="true">üîß</span>
        <span class="bottom-nav-label">Tools</span>
      </a>
      <button type="button" class="bottom-nav-item" id="bottom-search-btn" aria-label="Search">
        <span class="bottom-nav-icon" aria-hidden="true">üîç</span>
        <span class="bottom-nav-label">Search</span>
      </button>
      <a href="stack.html" class="bottom-nav-item">
        <span class="bottom-nav-icon" aria-hidden="true">üìö</span>
        <span class="bottom-nav-label">My Stack</span>
      </a>
      <button type="button" class="bottom-nav-item" id="bottom-more-btn" aria-label="More pages">
        <span class="bottom-nav-icon" aria-hidden="true">‚ò∞</span>
        <span class="bottom-nav-label">More</span>
      </button>
    </div>
  </nav>

  <div class="nav-backdrop" id="nav-backdrop" aria-hidden="true"></div>

  <footer class="footer">
    <span class="footer-logo">&#x2B22;</span>
    <p>AI Knowledge Hub &mdash; 2026</p>
    <div class="footer-links">
      <a href="index.html" class="footer-link">Home</a>
      <span class="footer-link-sep">¬∑</span>
      <a href="stack.html" class="footer-link">My Stack</a>
      <span class="footer-link-sep">¬∑</span>
      <a href="about.html" class="footer-link">About</a>
    </div>
  </footer>

  <script src="auth.js"></script>
  <script src="profiles.js"></script>
  <script src="profile-switcher.js"></script>
  <script src="bottom-nav.js"></script>
  <script>
    (function () {
      const navLogin = document.getElementById("nav-login");
      const authWrap = document.getElementById("auth-user-wrap");
      const authEmail = document.getElementById("auth-user-email");
      const navLogout = document.getElementById("nav-logout");
      if (navLogin && authWrap) {
        function updateAuthNav() {
          const session = window.Auth && window.Auth.getSession();
          const isAdmin = window.Auth && window.Auth.isAdmin();
          if (session) {
            navLogin.style.display = "none";
            authWrap.style.display = "inline-flex";
            if (authEmail) authEmail.textContent = session.email;
          } else {
            navLogin.style.display = "block";
            authWrap.style.display = "none";
          }
          const adminSection = document.getElementById("profile-admin-section");
          if (adminSection) adminSection.style.display = session ? "block" : "none";
          const settingsSection = document.getElementById("profile-settings-section");
          if (settingsSection) settingsSection.style.display = session && isAdmin ? "block" : "none";
          const settingsEmail = document.getElementById("settings-account-email");
          if (settingsEmail) settingsEmail.textContent = session ? session.email : "";
        }
        updateAuthNav();
        window.addEventListener("auth-changed", updateAuthNav);
        if (navLogout) navLogout.addEventListener("click", () => window.Auth.logout());
        const settingsLogout = document.getElementById("settings-logout");
        if (settingsLogout) settingsLogout.addEventListener("click", () => window.Auth.logout());
      }
    })();
  </script>
  <script>
    (function () {
      const navToggle = document.getElementById("nav-toggle");
      const navTabs = document.querySelector(".nav-tabs");
      navToggle?.addEventListener("click", () => navTabs?.classList.toggle("open"));

      function announceProfileSwitch(name) {
        const announcer = document.getElementById("profile-announcer");
        if (announcer) {
          announcer.textContent = "Switched to " + (name || "profile");
          setTimeout(() => { announcer.textContent = ""; }, 1000);
        }
      }

      function switchToProfile(id, name) {
        if (!id) return;
        window.ProfileStore.setActiveProfile(id);
        announceProfileSwitch(name);
        render();
      }

      function render() {
        const list = document.getElementById("profiles-list");
        const profiles = window.ProfileStore?.getProfiles() || [];
        const activeId = window.ProfileStore?.getActiveProfileId();
        const editingId = list.dataset.editingId || "";

        list.innerHTML = profiles.map((p) => {
          const isEditing = p.id === editingId;
          return `
          <div class="profile-item ${p.id === activeId ? "active" : ""}" data-profile-id="${escapeAttr(p.id)}" role="option" id="profile-option-${escapeAttr(p.id)}" aria-selected="${p.id === activeId}">
            <div class="profile-item-info">
              ${isEditing
                ? `<form class="profile-rename-form" data-id="${escapeAttr(p.id)}">
                    <input type="text" value="${escapeAttr(p.name)}" maxlength="50" aria-label="Profile name" required>
                    <button type="submit" class="profile-rename-save">Save</button>
                    <button type="button" class="profile-rename-cancel" data-id="${escapeAttr(p.id)}">Cancel</button>
                  </form>`
                : `<strong class="profile-item-name">${escapeHtml(p.name)}</strong>
                   ${p.id === activeId ? '<span class="profile-item-badge">Active</span>' : ""}`}
            </div>
            <div class="profile-item-actions">
              ${!isEditing ? (
                `<button type="button" class="profile-item-rename" data-id="${escapeAttr(p.id)}" data-name="${escapeAttr(p.name)}" aria-label="Rename ${escapeAttr(p.name)}">Rename</button>` +
                `<button type="button" class="profile-item-duplicate" data-id="${escapeAttr(p.id)}" data-name="${escapeAttr(p.name)}" aria-label="Duplicate ${escapeAttr(p.name)}">Duplicate</button>` +
                (p.id !== activeId ? `<button type="button" class="profile-item-switch" data-id="${escapeAttr(p.id)}" data-name="${escapeAttr(p.name)}">Switch</button>` : "") +
                (profiles.length > 1 ? `
                  <span class="profile-delete-wrap">
                    <button type="button" class="profile-item-delete" data-id="${escapeAttr(p.id)}" aria-label="Delete profile">Delete</button>
                    <span class="profile-delete-confirm hidden">
                      <span class="profile-delete-msg">Delete profile? This cannot be undone.</span>
                      <button type="button" class="profile-delete-yes" data-id="${escapeAttr(p.id)}">Yes</button>
                      <button type="button" class="profile-delete-no">No</button>
                    </span>
                  </span>` : "")
              ) : ""}
            </div>
          </div>`;
        }).join("") || '<p class="section-empty">No profiles yet. Create one below.</p>';

        list.querySelectorAll(".profile-item-duplicate").forEach((btn) => {
          btn.addEventListener("click", () => {
            const newId = window.ProfileStore.duplicateProfile(btn.dataset.id);
            if (newId) render();
          });
        });
        list.querySelectorAll(".profile-item-switch").forEach((btn) => {
          btn.addEventListener("click", () => switchToProfile(btn.dataset.id, btn.dataset.name));
          btn.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              switchToProfile(btn.dataset.id, btn.dataset.name);
            }
          });
        });
        list.querySelectorAll(".profile-item-rename").forEach((btn) => {
          btn.addEventListener("click", () => {
            list.dataset.editingId = btn.dataset.id;
            render();
            const form = list.querySelector(`.profile-rename-form[data-id="${btn.dataset.id}"]`);
            if (form) {
              const input = form.querySelector("input");
              input.focus();
              input.select();
            }
          });
        });
        list.querySelectorAll(".profile-rename-form").forEach((form) => {
          form.addEventListener("submit", (e) => {
            e.preventDefault();
            const name = (form.querySelector("input").value || "").trim();
            if (name) {
              window.ProfileStore.renameProfile(form.dataset.id, name);
              delete list.dataset.editingId;
              render();
            }
          });
          form.addEventListener("keydown", (e) => {
            if (e.key === "Escape") {
              e.preventDefault();
              delete list.dataset.editingId;
              render();
            }
          });
        });
        list.querySelectorAll(".profile-rename-cancel").forEach((btn) => {
          const cancelRename = () => { delete list.dataset.editingId; render(); };
          btn.addEventListener("click", cancelRename);
          btn.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") { e.preventDefault(); cancelRename(); }
            if (e.key === "Escape") { e.preventDefault(); cancelRename(); }
          });
        });
        list.querySelectorAll(".profile-item-delete").forEach((btn) => {
          btn.addEventListener("click", () => {
            btn.classList.add("hidden");
            btn.nextElementSibling?.classList.remove("hidden");
          });
        });
        list.querySelectorAll(".profile-delete-no").forEach((btn) => {
          const cancelDelete = () => {
            const wrap = btn.closest(".profile-delete-wrap");
            wrap?.querySelector(".profile-item-delete")?.classList.remove("hidden");
            wrap?.querySelector(".profile-delete-confirm")?.classList.add("hidden");
          };
          btn.addEventListener("click", cancelDelete);
          btn.addEventListener("keydown", (e) => {
            if (["Escape", "Enter", " "].includes(e.key)) {
              e.preventDefault();
              cancelDelete();
            }
          });
        });
        list.querySelectorAll(".profile-delete-yes").forEach((btn) => {
          btn.addEventListener("click", () => {
            window.ProfileStore.deleteProfile(btn.dataset.id);
            render();
          });
        });
      }

      function escapeHtml(s) {
        const d = document.createElement("div");
        d.textContent = s;
        return d.innerHTML;
      }
      function escapeAttr(s) {
        return escapeHtml(s).replace(/"/g, "&quot;");
      }

      document.getElementById("profile-form").addEventListener("submit", (e) => {
        e.preventDefault();
        const input = document.getElementById("profile-name");
        const name = (input.value || "").trim();
        if (!name) return;
        window.ProfileStore.createProfile(name);
        input.value = "";
        render();
      });

      function showFeedback(msg, isError) {
        const el = document.getElementById("data-feedback");
        if (!el) return;
        el.textContent = msg;
        el.style.display = "block";
        el.classList.toggle("data-feedback-error", !!isError);
        setTimeout(() => { el.style.display = "none"; }, 4000);
      }

      document.getElementById("data-export-btn")?.addEventListener("click", () => {
        const payload = {
          v: 1,
          exportedAt: new Date().toISOString(),
          profiles: localStorage.getItem("profiles"),
          activeProfileId: localStorage.getItem("activeProfileId"),
          profileData: localStorage.getItem("profileData"),
          customTools: localStorage.getItem("customTools"),
          theme: localStorage.getItem("theme"),
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "ai-knowledge-hub-backup-" + new Date().toISOString().slice(0, 10) + ".json";
        a.click();
        URL.revokeObjectURL(a.href);
        showFeedback("Backup downloaded.");
      });

      document.getElementById("data-import-input")?.addEventListener("change", (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        const r = new FileReader();
        r.onerror = () => showFeedback("Could not read file", true);
        r.onload = () => {
          try {
            const raw = r.result;
            if (typeof raw !== "string" || !raw.trim()) throw new Error("File is empty");
            const payload = JSON.parse(raw);
            if (!payload || typeof payload !== "object") throw new Error("Invalid backup format ‚Äî expected JSON object");
            if (!payload.v && !payload.profiles && !payload.profileData) throw new Error("Not a valid AI Knowledge Hub backup file");
            if (payload.profiles) localStorage.setItem("profiles", payload.profiles);
            if (payload.activeProfileId) localStorage.setItem("activeProfileId", payload.activeProfileId);
            if (payload.profileData) localStorage.setItem("profileData", payload.profileData);
            if (payload.customTools) localStorage.setItem("customTools", payload.customTools);
            if (payload.theme) localStorage.setItem("theme", payload.theme);
            window.dispatchEvent(new CustomEvent("profile-changed"));
            showFeedback("Data restored. Reloading‚Ä¶");
            setTimeout(() => window.location.reload(), 800);
          } catch (err) {
            const msg = err instanceof SyntaxError ? "Invalid JSON ‚Äî file may be corrupted" : (err.message || "Unknown error");
            showFeedback("Import failed: " + msg, true);
          }
        };
        r.readAsText(file);
        e.target.value = "";
      });

      render();
      window.addEventListener("profile-changed", render);

      (function profileAdminSection() {
        const section = document.getElementById("profile-admin-section");
        if (!section) return;
        function initProfileAdmin() {
          if (!window.Auth?.isLoggedIn() || window.Auth?.isAdmin()) return;
          renderProfileCustomList();
          renderProfileExport();
        }
        let profileEditCat = null;
        let profileEditIndex = null;

        function getCustomTools() {
          try {
            const j = localStorage.getItem("customTools");
            return j ? JSON.parse(j) : { tools: [], knowledge: [], podcasts: [], youtube: [], training: [], dailyWatch: [], bleedingEdge: [] };
          } catch (_) {
            return { tools: [], knowledge: [], podcasts: [], youtube: [], training: [], dailyWatch: [], bleedingEdge: [] };
          }
        }
        function saveCustomTools(data) {
          localStorage.setItem("customTools", JSON.stringify(data));
        }
        function clearProfileEdit() {
          profileEditCat = null;
          profileEditIndex = null;
          document.getElementById("profile-tool-form-heading").textContent = "Add tool";
          document.querySelector("#profile-tool-form [type=submit]").textContent = "Add tool";
          document.getElementById("profile-cancel-edit").style.display = "none";
          document.getElementById("profile-tool-form").reset();
          document.getElementById("profile-tool-level").value = "1";
        }
        function escapeJs(s) {
          return String(s || "").replace(/\\/g, "\\\\").replace(/"/g, '\\"').replace(/\n/g, "\\n");
        }

        document.getElementById("profile-tool-form").addEventListener("submit", (e) => {
          e.preventDefault();
          const tags = (document.getElementById("profile-tool-tags").value || "").split(",").map((t) => t.trim()).filter(Boolean);
          const color1 = document.getElementById("profile-tool-color1")?.value || "#10a37f";
          const color2 = document.getElementById("profile-tool-color2")?.value || "#1a7f5a";
          const item = {
            title: document.getElementById("profile-tool-title").value.trim(),
            description: document.getElementById("profile-tool-description").value.trim(),
            url: document.getElementById("profile-tool-url").value.trim() || "#",
            tags,
            icon: document.getElementById("profile-tool-icon").value.trim() || "üîó",
            color: [color1, color2],
            level: parseInt(document.getElementById("profile-tool-level").value, 10) || 1,
            freq: document.getElementById("profile-tool-freq").value.trim() || "Continuous",
          };
          const cat = document.getElementById("profile-tool-category").value;
          const data = getCustomTools();
          if (!data[cat]) data[cat] = [];
          if (profileEditCat !== null && profileEditIndex !== null) {
            if (profileEditCat === cat) {
              data[cat][profileEditIndex] = item;
            } else {
              data[profileEditCat].splice(profileEditIndex, 1);
              data[cat].push(item);
            }
            clearProfileEdit();
          } else {
            data[cat].push(item);
          }
          saveCustomTools(data);
          document.getElementById("profile-tool-form").reset();
          document.getElementById("profile-tool-level").value = "1";
          renderProfileCustomList();
          renderProfileExport();
        });

        document.getElementById("profile-reset-form")?.addEventListener("click", clearProfileEdit);
        document.getElementById("profile-cancel-edit")?.addEventListener("click", clearProfileEdit);

        function renderProfileCustomList() {
          const data = getCustomTools();
          const names = ["tools", "knowledge", "podcasts", "youtube", "training", "dailyWatch", "bleedingEdge"];
          const labels = { tools: "AI Tools", knowledge: "Knowledge", podcasts: "Podcasts", youtube: "YouTube", training: "Training", dailyWatch: "Daily Watch", bleedingEdge: "Bleeding Edge" };
          let html = "";
          names.forEach((cat) => {
            const items = data[cat] || [];
            if (items.length === 0) return;
            html += `<h2 class="profile-form-title">${labels[cat]} (${items.length})</h2>`;
            items.forEach((it, i) => {
              const hasUrl = it.url && it.url !== "#";
              const titlePart = hasUrl ? `<a href="${escapeAttr(it.url)}" target="_blank" rel="noopener">${escapeHtml(it.title)}</a>` : escapeHtml(it.title);
              html += `<div class="admin-tool-item">
                <span>${titlePart}</span>
                <div class="admin-tool-actions" style="display:flex;gap:0.5rem">
                  <button type="button" class="admin-edit-btn" data-cat="${escapeAttr(cat)}" data-i="${i}">Edit</button>
                  <button type="button" data-action="remove" data-cat="${escapeAttr(cat)}" data-i="${i}">Remove</button>
                </div>
              </div>`;
            });
          });
          const el = document.getElementById("profile-custom-tools-list");
          el.innerHTML = html || '<p class="section-empty">No custom tools yet.</p>';
          el.querySelectorAll(".admin-edit-btn").forEach((btn) => {
            btn.addEventListener("click", () => {
              const data = getCustomTools();
              const item = (data[btn.dataset.cat] || [])[parseInt(btn.dataset.i, 10)];
              if (!item) return;
              profileEditCat = btn.dataset.cat;
              profileEditIndex = parseInt(btn.dataset.i, 10);
              document.getElementById("profile-tool-title").value = item.title || "";
              document.getElementById("profile-tool-description").value = item.description || "";
              document.getElementById("profile-tool-url").value = (item.url && item.url !== "#") ? item.url : "";
              document.getElementById("profile-tool-category").value = profileEditCat;
              document.getElementById("profile-tool-icon").value = item.icon || "üîó";
              document.getElementById("profile-tool-level").value = String(item.level || 1);
              document.getElementById("profile-tool-freq").value = item.freq || "Continuous";
              document.getElementById("profile-tool-tags").value = (item.tags || []).join(", ");
              document.getElementById("profile-tool-form-heading").textContent = "Edit tool";
              document.querySelector("#profile-tool-form [type=submit]").textContent = "Save changes";
              document.getElementById("profile-cancel-edit").style.display = "inline-block";
            });
          });
          el.querySelectorAll("button[data-action='remove']").forEach((btn) => {
            btn.addEventListener("click", () => {
              const data = getCustomTools();
              const cat = btn.dataset.cat;
              const i = parseInt(btn.dataset.i, 10);
              if (profileEditCat === cat && profileEditIndex === i) clearProfileEdit();
              data[cat].splice(i, 1);
              saveCustomTools(data);
              renderProfileCustomList();
              renderProfileExport();
            });
          });
        }

        function renderProfileExport() {
          const data = getCustomTools();
          const names = ["tools", "knowledge", "podcasts", "youtube", "training", "dailyWatch", "bleedingEdge"];
          const labels = { tools: "siteData.tools", knowledge: "siteData.knowledge", podcasts: "siteData.podcasts", youtube: "siteData.youtube", training: "siteData.training", dailyWatch: "siteData.dailyWatch", bleedingEdge: "siteData.bleedingEdge" };
          const parts = [];
          names.forEach((cat) => {
            const items = data[cat] || [];
            if (items.length === 0) return;
            const arrStr = items.map((it) => {
              const tags = (it.tags || []).map((t) => `"${escapeJs(t)}"`).join(", ");
              return `    { title: "${escapeJs(it.title)}", description: "${escapeJs(it.description)}", url: "${escapeJs(it.url || "#")}", tags: [${tags}], icon: "${escapeJs(it.icon || "üîó")}", color: ["${it.color?.[0] || "#333"}","${it.color?.[1] || "#222"}"], level: ${it.level || 1}, freq: "${escapeJs(it.freq || "Continuous")}" }`;
            }).join(",\n");
            parts.push(`// Add to ${labels[cat]} in data.js:\n${arrStr}`);
          });
          const out = document.getElementById("profile-export-output");
          out.textContent = parts.length ? parts.join("\n\n") : "// No custom tools to export";
        }

        document.getElementById("profile-admin-copy")?.addEventListener("click", () => {
          const pre = document.getElementById("profile-export-output");
          const feedback = document.getElementById("profile-copy-feedback");
          navigator.clipboard.writeText(pre?.textContent || "").then(() => {
            if (feedback) { feedback.textContent = "Copied!"; setTimeout(() => { feedback.textContent = ""; }, 2000); }
          });
        });

        initProfileAdmin();
        window.addEventListener("auth-changed", initProfileAdmin);
        window.addEventListener("profile-changed", () => {
          if (section.style.display !== "none") {
            renderProfileCustomList();
            renderProfileExport();
          }
        });
      })();
    })();
  </script>
</body>
</html>
