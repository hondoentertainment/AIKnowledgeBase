<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Profiles | AI Knowledge Hub</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,600;1,400&family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600;9..40,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <header class="topbar">
    <div class="topbar-inner">
      <a href="index.html" class="logo">
        <span class="logo-icon">&#x2B22;</span>
        AI Knowledge Hub
      </a>
      <nav class="nav-tabs">
        <a href="index.html#tools" class="nav-tab">Tools</a>
        <a href="index.html#knowledge" class="nav-tab">Knowledge</a>
        <a href="index.html#podcasts" class="nav-tab">Podcasts</a>
        <a href="index.html#youtube" class="nav-tab">YouTube</a>
        <a href="index.html#training" class="nav-tab">Training</a>
        <a href="index.html#bleeding-edge" class="nav-tab">Bleeding Edge</a>
        <a href="niche.html" class="nav-tab">Niche AI</a>
        <a href="stack.html" class="nav-tab">My Stack</a>
        <a href="profiles.html" class="nav-tab active">Profiles</a>
        <a href="admin.html" class="nav-tab">Admin</a>
        <a href="login.html" class="nav-tab" id="nav-login">Log in</a>
        <span class="auth-user-wrap" id="auth-user-wrap" style="display:none">
          <span class="auth-user-email" id="auth-user-email"></span>
          <button type="button" class="nav-tab nav-tab-btn" id="nav-logout">Log out</button>
        </span>
        <a href="about.html" class="nav-tab">About</a>
      </nav>
      <div class="topbar-actions">
        <div class="profile-switcher" id="profile-switcher"></div>
        <button type="button" class="nav-toggle" id="nav-toggle" aria-label="Toggle menu" aria-expanded="false">
          <span class="nav-toggle-bar"></span>
          <span class="nav-toggle-bar"></span>
          <span class="nav-toggle-bar"></span>
        </button>
        <button id="theme-btn" class="icon-btn" aria-label="Toggle theme" aria-pressed="true">
          <svg class="icon-moon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
          <svg class="icon-sun" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
        </button>
      </div>
    </div>
  </header>

  <main class="main profiles-main" id="main-content" style="max-width: 600px; margin: 0 auto; padding: 2rem 1.25rem;">
    <section class="section">
      <h1 class="section-title">Profiles</h1>
      <p class="section-intro" style="margin-bottom: 1.5rem;">Each profile has its own stack, ratings, and flags. Switch between Work, Personal, or any other context.</p>

      <div class="data-export-import">
        <h2 class="profile-form-title">Backup & restore</h2>
        <p class="section-intro" style="margin-bottom: 0.75rem;">Export your profiles, stack, ratings, and flags. Import on another device to restore.</p>
        <div class="data-actions">
          <button type="button" id="data-export-btn" class="profile-form-btn">Export data</button>
          <label class="data-import-label">
            <input type="file" id="data-import-input" accept=".json,application/json" class="sr-only">
            <span class="profile-form-btn">Import data</span>
          </label>
        </div>
        <p id="data-feedback" class="data-feedback" role="status" aria-live="polite" style="display:none"></p>
      </div>

      <div id="profiles-list" class="profiles-list"></div>

      <form id="profile-form" class="profile-form">
        <h2 class="profile-form-title">Create profile</h2>
        <div class="profile-form-row">
          <input type="text" id="profile-name" placeholder="Profile name" required maxlength="50" aria-label="Profile name">
          <button type="submit" class="profile-form-btn">Add</button>
        </div>
      </form>
    </section>
  </main>

  <footer class="footer">
    <span class="footer-logo">&#x2B22;</span>
    <p>AI Knowledge Hub &mdash; 2026</p>
    <div class="footer-links">
      <a href="index.html" class="footer-link">Home</a>
      <span class="footer-link-sep">·</span>
      <a href="stack.html" class="footer-link">My Stack</a>
      <span class="footer-link-sep">·</span>
      <a href="admin.html" class="footer-link">Admin</a>
      <span class="footer-link-sep">·</span>
      <a href="about.html" class="footer-link">About</a>
    </div>
  </footer>

  <script src="auth.js"></script>
  <script src="profiles.js"></script>
  <script src="profile-switcher.js"></script>
  <script>
    (function () {
      const navLogin = document.getElementById("nav-login");
      const authWrap = document.getElementById("auth-user-wrap");
      const authEmail = document.getElementById("auth-user-email");
      const navLogout = document.getElementById("nav-logout");
      if (navLogin && authWrap) {
        function updateAuthNav() {
          const session = window.Auth && window.Auth.getSession();
          if (session) {
            navLogin.style.display = "none";
            authWrap.style.display = "inline-flex";
            if (authEmail) authEmail.textContent = session.email;
          } else {
            navLogin.style.display = "block";
            authWrap.style.display = "none";
          }
        }
        updateAuthNav();
        window.addEventListener("auth-changed", updateAuthNav);
        if (navLogout) navLogout.addEventListener("click", () => window.Auth.logout());
      }
    })();
  </script>
  <script>
    (function () {
      const themeBtn = document.getElementById("theme-btn");
      const savedTheme = localStorage.getItem("theme") || (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
      document.documentElement.setAttribute("data-theme", savedTheme);
      themeBtn?.addEventListener("click", () => {
        const next = document.documentElement.getAttribute("data-theme") === "dark" ? "light" : "dark";
        document.documentElement.setAttribute("data-theme", next);
        localStorage.setItem("theme", next);
      });

      const navToggle = document.getElementById("nav-toggle");
      const navTabs = document.querySelector(".nav-tabs");
      navToggle?.addEventListener("click", () => navTabs?.classList.toggle("open"));

      function render() {
        const list = document.getElementById("profiles-list");
        const profiles = window.ProfileStore?.getProfiles() || [];
        const activeId = window.ProfileStore?.getActiveProfileId();
        const editingId = list.dataset.editingId || "";

        list.innerHTML = profiles.map((p) => {
          const isEditing = p.id === editingId;
          return `
          <div class="profile-item ${p.id === activeId ? "active" : ""}" data-profile-id="${escapeAttr(p.id)}">
            <div class="profile-item-info">
              ${isEditing
                ? `<form class="profile-rename-form" data-id="${escapeAttr(p.id)}">
                    <input type="text" value="${escapeAttr(p.name)}" maxlength="50" aria-label="Profile name" required>
                    <button type="submit" class="profile-rename-save">Save</button>
                    <button type="button" class="profile-rename-cancel" data-id="${escapeAttr(p.id)}">Cancel</button>
                  </form>`
                : `<strong class="profile-item-name">${escapeHtml(p.name)}</strong>
                   ${p.id === activeId ? '<span class="profile-item-badge">Active</span>' : ""}`}
            </div>
            <div class="profile-item-actions">
              ${!isEditing ? (
                `<button type="button" class="profile-item-rename" data-id="${escapeAttr(p.id)}" data-name="${escapeAttr(p.name)}" aria-label="Rename ${escapeAttr(p.name)}">Rename</button>` +
                (p.id !== activeId ? `<button type="button" class="profile-item-switch" data-id="${escapeAttr(p.id)}">Switch</button>` : "") +
                (profiles.length > 1 ? `
                  <span class="profile-delete-wrap">
                    <button type="button" class="profile-item-delete" data-id="${escapeAttr(p.id)}" aria-label="Delete profile">Delete</button>
                    <span class="profile-delete-confirm hidden">
                      <span class="profile-delete-msg">Delete?</span>
                      <button type="button" class="profile-delete-yes" data-id="${escapeAttr(p.id)}">Yes</button>
                      <button type="button" class="profile-delete-no">No</button>
                    </span>
                  </span>` : "")
              ) : ""}
            </div>
          </div>`;
        }).join("") || '<p class="section-empty">No profiles yet. Create one below.</p>';

        list.querySelectorAll(".profile-item-switch").forEach((btn) => {
          btn.addEventListener("click", () => {
            window.ProfileStore.setActiveProfile(btn.dataset.id);
            render();
          });
        });
        list.querySelectorAll(".profile-item-rename").forEach((btn) => {
          btn.addEventListener("click", () => {
            list.dataset.editingId = btn.dataset.id;
            render();
            const form = list.querySelector(`.profile-rename-form[data-id="${btn.dataset.id}"]`);
            if (form) {
              const input = form.querySelector("input");
              input.focus();
              input.select();
            }
          });
        });
        list.querySelectorAll(".profile-rename-form").forEach((form) => {
          form.addEventListener("submit", (e) => {
            e.preventDefault();
            const name = (form.querySelector("input").value || "").trim();
            if (name) {
              window.ProfileStore.renameProfile(form.dataset.id, name);
              delete list.dataset.editingId;
              render();
            }
          });
        });
        list.querySelectorAll(".profile-rename-cancel").forEach((btn) => {
          btn.addEventListener("click", () => {
            delete list.dataset.editingId;
            render();
          });
        });
        list.querySelectorAll(".profile-item-delete").forEach((btn) => {
          btn.addEventListener("click", () => {
            btn.classList.add("hidden");
            btn.nextElementSibling?.classList.remove("hidden");
          });
        });
        list.querySelectorAll(".profile-delete-no").forEach((btn) => {
          btn.addEventListener("click", () => {
            const wrap = btn.closest(".profile-delete-wrap");
            wrap?.querySelector(".profile-item-delete")?.classList.remove("hidden");
            wrap?.querySelector(".profile-delete-confirm")?.classList.add("hidden");
          });
        });
        list.querySelectorAll(".profile-delete-yes").forEach((btn) => {
          btn.addEventListener("click", () => {
            window.ProfileStore.deleteProfile(btn.dataset.id);
            render();
          });
        });
      }

      function escapeHtml(s) {
        const d = document.createElement("div");
        d.textContent = s;
        return d.innerHTML;
      }
      function escapeAttr(s) {
        return escapeHtml(s).replace(/"/g, "&quot;");
      }

      document.getElementById("profile-form").addEventListener("submit", (e) => {
        e.preventDefault();
        const input = document.getElementById("profile-name");
        const name = (input.value || "").trim();
        if (!name) return;
        window.ProfileStore.createProfile(name);
        input.value = "";
        render();
      });

      function showFeedback(msg, isError) {
        const el = document.getElementById("data-feedback");
        if (!el) return;
        el.textContent = msg;
        el.style.display = "block";
        el.classList.toggle("data-feedback-error", !!isError);
        setTimeout(() => { el.style.display = "none"; }, 4000);
      }

      document.getElementById("data-export-btn")?.addEventListener("click", () => {
        const payload = {
          v: 1,
          exportedAt: new Date().toISOString(),
          profiles: localStorage.getItem("profiles"),
          activeProfileId: localStorage.getItem("activeProfileId"),
          profileData: localStorage.getItem("profileData"),
          customTools: localStorage.getItem("customTools"),
          theme: localStorage.getItem("theme"),
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "ai-knowledge-hub-backup-" + new Date().toISOString().slice(0, 10) + ".json";
        a.click();
        URL.revokeObjectURL(a.href);
        showFeedback("Backup downloaded.");
      });

      document.getElementById("data-import-input")?.addEventListener("change", (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        const r = new FileReader();
        r.onload = () => {
          try {
            const payload = JSON.parse(r.result);
            if (!payload || typeof payload !== "object") throw new Error("Invalid backup file");
            if (payload.profiles) localStorage.setItem("profiles", payload.profiles);
            if (payload.activeProfileId) localStorage.setItem("activeProfileId", payload.activeProfileId);
            if (payload.profileData) localStorage.setItem("profileData", payload.profileData);
            if (payload.customTools) localStorage.setItem("customTools", payload.customTools);
            if (payload.theme) localStorage.setItem("theme", payload.theme);
            window.dispatchEvent(new CustomEvent("profile-changed"));
            showFeedback("Data restored. Reloading…");
            setTimeout(() => window.location.reload(), 800);
          } catch (err) {
            showFeedback("Import failed: " + (err.message || "Invalid file"), true);
          }
        };
        r.readAsText(file);
        e.target.value = "";
      });

      render();
      window.addEventListener("profile-changed", render);
    })();
  </script>
</body>
</html>
